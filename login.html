<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول - إدارة أموالي</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <style>
        /* أضف هنا كود CSS الخاص بصفحة تسجيل الدخول */
    </style>
</head>
<body>
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2><i class="bi bi-wallet2"></i> إدارة أموالي</h2>
                <p>نظام متكامل لإدارة الشؤون المالية</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox" id="rememberMe">
                        <label class="form-check-label" for="rememberMe">تذكرني</label>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-custom">تسجيل الدخول</button>
                    </div>
                    <div class="text-center mt-3">
                        <a href="#" id="forgotPasswordLink">نسيت كلمة المرور؟</a>
                    </div>
                </form>
                <hr>
                <div class="d-grid gap-2">
                    <button id="googleBtn" class="btn btn-danger btn-custom">
                        <i class="bi bi-google"></i> تسجيل الدخول بحساب Google
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Initialization -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAl_ZKb22fC4h-3lV-QGlHFy6BYtW_eBa8",
            authDomain: "amoaliapp.firebaseapp.com",
            projectId: "amoaliapp",
            storageBucket: "amoaliapp.firebasestorage.app",
            messagingSenderId: "544882310161",
            appId: "1:544882310161:web:8fc74ebc7bffac0d60c5b0",
            measurementId: "G-BX4Z7XHS34"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            
            // Check if Firebase is initialized
            if (!firebase.apps.length) {
                console.error('Firebase not initialized');
                return;
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Check login status
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    console.log('User is signed in:', user.uid);
                    
                    // Get user data from Firestore
                    db.collection('users').doc(user.uid).get().then(function(doc) {
                        if (doc.exists) {
                            const userData = doc.data();
                            
                            // Save user to localStorage if "remember me" is checked
                            const rememberMe = document.getElementById('rememberMe').checked;
                            if (rememberMe) {
                                localStorage.setItem('currentUser', JSON.stringify({
                                    uid: user.uid,
                                    email: user.email,
                                    displayName: user.displayName,
                                    role: userData.role || 'user'
                                }));
                            }
                            
                            // Redirect to index.html
                            window.location.href = 'index.html';
                        } else {
                            // Create user document if it doesn't exist
                            db.collection('users').doc(user.uid).set({
                                email: user.email,
                                role: 'user',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }).then(function() {
                                // Redirect to index.html
                                window.location.href = 'index.html';
                            }).catch(function(error) {
                                console.error('Error creating user document:', error);
                                showToast('حدث خطأ أثناء إنشاء بيانات المستخدم', 'error');
                            });
                        }
                    }).catch(function(error) {
                        console.error('Error getting user data:', error);
                        showToast('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
                    });
                } else {
                    // User is signed out
                    console.log('User is signed out');
                }
            });
        });
        
        function setupEventListeners() {
            // Login Form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('email').value.trim();
                    const password = document.getElementById('password').value.trim();
                    const rememberMe = document.getElementById('rememberMe').checked;
                    
                    if (!email || !password) {
                        showToast('يرجى إدخال البريد الإلكتروني وكلمة المرور', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const submitBtn = loginForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري تسجيل الدخول...';
                    submitBtn.disabled = true;
                    
                    firebase.auth().signInWithEmailAndPassword(email, password)
                        .then(function(userCredential) {
                            const user = userCredential.user;
                            console.log('Signed in successfully:', user.uid);
                            
                            // The redirect will be handled by the onAuthStateChanged listener
                        })
                        .catch(function(error) {
                            console.error('Sign in error:', error);
                            let errorMessage = 'فشل تسجيل الدخول';
                            
                            if (error.code === 'auth/user-not-found') {
                                errorMessage = 'المستخدم غير موجود';
                            } else if (error.code === 'auth/wrong-password') {
                                errorMessage = 'كلمة المرور غير صحيحة';
                            } else if (error.code === 'auth/invalid-email') {
                                errorMessage = 'البريد الإلكتروني غير صالح';
                            } else if (error.code === 'auth/user-disabled') {
                                errorMessage = 'حساب المستخدم معطل';
                            } else if (error.code === 'auth/too-many-requests') {
                                errorMessage = 'تم تجاوز عدد المحاولات المسموح بها، يرجى المحاولة لاحقاً';
                            } else {
                                errorMessage = error.message;
                            }
                            
                            showToast(errorMessage, 'error');
                            
                            // Reset button state
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        });
                });
            }
            
            // Google Sign-In Button
            const googleBtn = document.getElementById('googleBtn');
            if (googleBtn) {
                googleBtn.addEventListener('click', function() {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    
                    // Show loading state
                    const originalText = googleBtn.innerHTML;
                    googleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> جاري تسجيل الدخول...';
                    googleBtn.disabled = true;
                    
                    firebase.auth().signInWithPopup(provider)
                        .then(function(result) {
                            const user = result.user;
                            console.log('Google sign in successful:', user.uid);
                            
                            // The redirect will be handled by the onAuthStateChanged listener
                        })
                        .catch(function(error) {
                            console.error('Google sign in error:', error);
                            let errorMessage = 'فشل تسجيل الدخول بحساب Google';
                            
                            if (error.code === 'auth/popup-closed-by-user') {
                                errorMessage = 'تم إغلاق نافذة تسجيل الدخول قبل إتمام العملية';
                            } else if (error.code === 'auth/cancelled-popup-request') {
                                errorMessage = 'تم إلغاء عملية تسجيل الدخول';
                            } else {
                                errorMessage = error.message;
                            }
                            
                            showToast(errorMessage, 'error');
                            
                            // Reset button state
                            googleBtn.innerHTML = originalText;
                            googleBtn.disabled = false;
                        });
                });
            }
            
            // Forgot Password Link
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const email = prompt('أدخل بريدك الإلكتروني لإرسال رابط استعادة كلمة المرور:');
                    
                    if (email) {
                        firebase.auth().sendPasswordResetEmail(email)
                            .then(function() {
                                showToast('تم إرسال رابط استعادة كلمة المرور إلى بريدك الإلكتروني');
                            })
                            .catch(function(error) {
                                console.error('Password reset error:', error);
                                let errorMessage = 'فشل إرسال رابط استعادة كلمة المرور';
                                
                                if (error.code === 'auth/user-not-found') {
                                    errorMessage = 'المستخدم غير موجود';
                                } else if (error.code === 'auth/invalid-email') {
                                    errorMessage = 'البريد الإلكتروني غير صالح';
                                } else {
                                    errorMessage = error.message;
                                }
                                
                                showToast(errorMessage, 'error');
                            });
                    }
                });
            }
        }
        
        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>